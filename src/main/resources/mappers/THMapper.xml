<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wolclass.mappers.THMapper">
	

 	
	<!-- 클래스 조회 TH -->
	<select id="selectClass" resultType="ClassVO">
	select * from wc_class where c_no=#{c_no}
	</select>
	

	<!-- 예약가능한 타임테이블 TH -->	
	<select id="getTimetable" resultType="TimetableVO">
	<![CDATA[  
	select * from wc_timetable
	where t_rem_p >0
	and c_no = #{c_no}
	]]>
	</select>
	
	<!-- 예약가능한 시간 타임테이블 TH -->	
	<select id="getTime" resultType="TimetableVO"> 
	<![CDATA[
	select t_no, t_start from wc_timetable
	where t_date=#{t_date} and c_no = #{c_no}
	and t_rem_p <= (select c_maxperson from wc_class where c_no=#{c_no})
	]]>
	</select>
	
	<!-- 예약가능한 최대 인원 구하기 TH -->
	<select id="getRemainNum" resultType="TimetableVO"> 
	<![CDATA[
	select t_no, t_rem_p from wc_timetable
	where c_no=#{c_no} and t_date = #{t_date} and t_start=#{t_start}
	]]>
	</select>
	
	<!-- 구독정보 조회 TH -->
	<select id="getSubsInfo" resultType="SubscriptionVO">
	select * from wc_subscription where m_id=#{m_id} and s_end>=now() and s_cnt>0
	</select>
	
	
	<!-- 마지막 주문번호 조회 TH -->
	<select id="maxP_no" resultType="int">
	select max(p_no) from wc_rsrv_pay;
	</select>
	
	
<!-- 결제시 insert,update -->
	
	<!-- 결제 테이블 isnert TH -->
	<insert id="insertPay">
	insert into wc_rsrv_pay(p_no, m_id, c_no, p_price, p_rsrvdate, p_key, p_peoplenum)
	values(#{p_no}, #{m_id}, #{c_no}, #{price}, #{p_rsrvdate}, #{p_key}, #{pNum})
	</insert>
	
	<!-- 타임테이블 t_rem_p 변경 TH -->
	<update id="updateT_rem_p">
	 update wc_timetable set t_rem_p=(t_rem_p-#{pNum}) where t_no=#{t_no}
	</update>
	
	<!-- 구독 쿠폰 사용시 subs테이블 count 변경 -->
	<update id="updateS_cnt">
	update wc_subscription set s_cnt=(s_cnt-1) where m_id=#{m_id}
	</update>
	
	<!-- 포인트 사용시 member테이블 point 변경 -->
	<update id="updatePoint">
	update wc_member set m_point=(m_point-#{point}) where m_id=#{m_id}
	</update>
</mapper>	